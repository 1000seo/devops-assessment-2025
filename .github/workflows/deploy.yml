name: receipt-analysis-ci-cd

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: receipt-analysis-repo
  ECS_CLUSTER: receipt-analysis-cluster
  ECS_SERVICE: receipt-analysis-service

jobs:
  # ---------------------------------
  # 1) Test Job
  # ---------------------------------
  test:
    name: test
    runs-on: ubuntu-latest
    steps:

      # í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì½”ë“œì˜ ìµœì‹  ìƒíƒœë¥¼ ê²€ì¦ í™˜ê²½ì— ë°˜ì˜í•˜ê¸° ìœ„í•¨
      - name: Checkout Code
        uses: actions/checkout@v4

      # í…ŒìŠ¤íŠ¸ ë° ì˜ì¡´ì„± ê²€ì¦ì´ ì¼ê´€ëœ Python í™˜ê²½ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ë²„ì „ ê³ ì •
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # ë°°í¬ ë‹¨ê³„ì—ì„œ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì‚¬ì „ ê²€ì¦
      - name: Install dependencies
        working-directory: ./app
        run: pip install -r requirements.txt

      # ì½”ë“œ ì»¨ë²¤ì…˜ ë° ì •ì  ì˜¤ë¥˜ë¥¼ ë°°í¬ ì „ì— íƒì§€í•˜ì—¬ í’ˆì§ˆ ì €í•˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•¨
      - name: Lint (flake8)
        run: pip install flake8 && flake8 . --count --exit-zero

      # ë¹Œë“œ/ë°°í¬ ì „ì— import ì˜¤ë¥˜ë¡œ ì¸í•œ ì‹¤í–‰ ì‹¤íŒ¨ë¥¼ ì¡°ê¸° ì°¨ë‹¨í•˜ê¸° ìœ„í•¨
      - name: Python Import Check
        working-directory: ./app
        run: python -c "import main"

  # ---------------------------------
  # 2) Build Job
  # ---------------------------------
  build:
    name: build
    runs-on: ubuntu-latest
    needs: test
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
    steps:
      # ê° Jobì—ì„œ ì‚¬ìš©í•  Task Definition/Dockerfile ë“± ë°°í¬ íŒŒì¼ì„ í•´ë‹¹ Runnerë¡œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # ì´ë¯¸ì§€ ê³ ìœ ì„± ë³´ì¥: Git SHAì˜ ë‹¨ì¶•ê°’ì„ IMAGE_TAGë¡œ ì„¤ì •í•˜ê³ , ì´í›„ Jobì—ì„œ ì¬ì‚¬ìš©í•˜ë„ë¡ outputìœ¼ë¡œ ë…¸ì¶œ
      - name: Set Short Image Tag
        id: set-tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "IMAGE_TAG=$SHORT_SHA" >> $GITHUB_ENV
          echo "IMAGE_TAG=$SHORT_SHA"
        # job outputìœ¼ë¡œ ë…¸ì¶œ
          echo "image_tag=$SHORT_SHA" >> $GITHUB_OUTPUT

      # ì´í›„ ë°°í¬ì—ì„œ ì‚¬ìš©í•  ì• í”Œë¦¬ì¼€ì´ì…˜ Docker ì´ë¯¸ì§€ë¥¼ CIì—ì„œ ìƒì„±
      - name: Build Docker Image
        working-directory: ./app
        run: |
          echo "ğŸ³ Building Docker image..."
          echo "âœ… Successfully build"
          echo "ğŸ· Successfully tagged"
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

      # ë°°í¬ ì „ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì·¨ì•½ì  ê²€ì¦ì„ í†µí•´ ë³´ì•ˆ ë¦¬ìŠ¤í¬ê°€ ìˆëŠ” ë°°í¬ ì°¨ë‹¨ ëª©ì 
      - name: Trivy Image Scan
        run: |
          echo "ğŸ” Trivy security scan would run here for: $ECR_REPOSITORY:$IMAGE_TAG"
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # uses: aquasecurity/trivy-action@@v0.24.0
        # with:
        #   image-ref: $ECR_REPOSITORY:$IMAGE_TAG
        #   severity: CRITICAL,HIGH
        #   ignore-unfixed: true
        #   exit-code: 1

      # ECR APIë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•œ IAM ì¸ì¦ ì„¤ì •
      # Build ë‹¨ê³„ì—ì„œë§Œ í•„ìš”í•œ ECR Push ê¶Œí•œ Roleì„ OIDCë¡œ Assumeí•˜ì—¬ ìµœì†Œ ê¶Œí•œ ë³´ì•ˆ ìœ ì§€
      - name: Configure AWS Credentials
        run: |
          echo "Successfully configured AWS credentials"
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # uses: aws-actions/configure-aws-credentials@v3
        # with:
        #   role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        #   aws-region: ap-northeast-2

      # ë¹Œë“œëœ Docker ì´ë¯¸ì§€ë¥¼ ECRì— í‘¸ì‹œí•˜ê¸° ìœ„í•œ ì¸ì¦(ë¡œê·¸ì¸)
      - name: Login to ECR
        run: |
          echo "Successfully ECR login "
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # uses: aws-actions/amazon-ecr-login@v2
        # with:
        #   mask-password: "true"

      # ECS Task ë°°í¬ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ECRì— ì €ì¥
      - name: Push Image to ECR
        run: |
          echo "ğŸš€ Tag & Push to ECR"
          echo "docker tag $ECR_REPOSITORY:$IMAGE_TAG <AWS_ACCOUNT>.dkr.ecr.ap-northeast-2.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "docker push <AWS_ACCOUNT>.dkr.ecr.ap-northeast-2.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG"
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        # docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  # ---------------------------------
  # 3) Deploy Job
  # ---------------------------------
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    needs: build
    env:
      # Build Jobì—ì„œ ìƒì„±í•œ IMAGE_TAGë¥¼ ë°°í¬ Jobì—ì„œ ì‚¬ìš©í•˜ë„ë¡ í™˜ê²½ë³€ìˆ˜ë¡œ ì „ë‹¬
      IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
    steps:

      # Deploy ë‹¨ê³„ì—ì„œë„ Task Definition íŒŒì¼(JSON)ì´ í•„ìš”í•˜ë¯€ë¡œ ì €ì¥ì†Œ ë‹¤ì‹œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # ECS APIë¥¼ í˜¸ì¶œí•˜ê¸° ìœ„í•œ IAM ì¸ì¦ ì„¤ì •
      # GitHub OIDC + AssumeRoleì„ ì‚¬ìš©í•´ ì¥ê¸° AWS í‚¤ ì—†ì´,
      # ì‹¤í–‰ ì‹œì ì—ë§Œ ì„ì‹œ ìê²© ì¦ëª…ì„ ë°œê¸‰í•˜ì—¬ ìµœì†Œ ê¶Œí•œ ì›ì¹™ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ë°°í¬ ìˆ˜í–‰
      - name: Configure AWS Credentials
        run: |
          echo "Successfully configured AWS credentials"

        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # uses: aws-actions/configure-aws-credentials@v3
        # with:
        #   role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        #   aws-region: ap-northeast-2

      # ECSê°€ ë‹¤ìŒ ë°°í¬ì—ì„œ ìµœì‹  ì´ë¯¸ì§€ë¥¼ ê°€ì§„ Taskë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ì¤€ë¹„ëœ Task Definition ë²„ì „ì„ ìƒì„±í•˜ê¸° ìœ„í•¨
      - name: Update image in task definition
        run: |
          echo "ğŸ“ Updating task definition image..."
          echo "âœ… Image updated in new-taskdef.json"
        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # cat task-definition.json | jq ".containerDefinitions[0].image=\"${ECR_URI}:${IMAGE_TAG}\"" > new-taskdef.json
        # cat task-definition.json | \
        # jq ".containerDefinitions[0].image=\"${ECR_URI}:${IMAGE_TAG}\"" > new-taskdef.json


      # ì—…ë°ì´íŠ¸ëœ ì´ë¯¸ì§€ ê¸°ë°˜ Taskë¥¼ ë°°í¬í•  ìˆ˜ ìˆë„ë¡ ìƒˆ Revisionì„ ì‚¬ì „ì— ë§Œë“¤ì–´ë‘ê¸° ìœ„í•¨
      - name: Register new ECS Task Definition
        id: register
        run: |
          echo "ğŸ“¦ Registering new task definition revision..."
          echo "âœ… New Task Definition ARN created"

        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # TASK_DEF_ARN=$(aws ecs register-task-definition \
        #   --cli-input-json file://new-taskdef.json \
        #   --query "taskDefinition.taskDefinitionArn" \
        #   --output text)

      # ECS ì„œë¹„ìŠ¤ê°€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ(=ì—…ë°ì´íŠ¸ëœ ì´ë¯¸ì§€)ë¡œ ì „í™˜ë˜ë„ë¡ ECSì— ë°°í¬ë¥¼ íŠ¸ë¦¬ê±°í•˜ê¸° ìœ„í•¨
      - name: Deploy new revision to ECS Service
        run: |
          echo "ğŸš€ Deploying new task revision to ECS..."
          echo "âœ… Deployment triggered"

        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # aws ecs update-service \
        #   --cluster $ECS_CLUSTER \
        #   --service $ECS_SERVICE \
        #   --task-definition ${{ steps.register.outputs.TASK_DEF_ARN }} \
        #   --force-new-deployment

      # ìƒˆ ë°°í¬ì˜ Taskê°€ ì •ìƒ ì‹¤í–‰ë˜ì–´ ë¬¸ì œê°€ ì—†ìŒì„ í™•ì¸í•œ í›„ ì¢…ë£Œí•˜ê¸° ìœ„í•¨
      - name: Wait for ECS to cut over
        run: |
          echo "â³ Waiting for ECS service to become stable..."
          echo "âœ… Service is now stable "

        # ì‹¤ì œ ì‹¤í–‰ ëª…ë ¹ì–´
        # aws ecs wait services-stable --cluster $ECS_CLUSTER --services $ECS_SERVICE